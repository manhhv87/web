{% extends "base.html" %}

{% block title %}Báo cáo tổng hợp - {{ app_name }}{% endblock %}

{% block content %}
<style>
    .rpt-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        border-radius: 12px;
        padding: 18px 24px;
        color: white;
        margin-bottom: 20px;
    }

    .rpt-header .user-info {
        font-size: 0.88rem;
        color: rgba(255, 255, 255, 0.85);
    }

    .card-clean {
        border: none;
        border-radius: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        overflow: hidden;
    }

    .card-clean .card-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: #fff;
        border-bottom: none;
        padding: 14px 20px;
        font-weight: 600;
        font-size: 0.92rem;
        border-radius: 0;
    }

    .card-clean .card-body { padding: 16px; }

    /* Category cards */
    .cat-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        height: 100%;
        background: #fff;
    }

    .cat-header {
        padding: 18px 20px 12px;
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .cat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        color: white;
        flex-shrink: 0;
    }

    .cat-title {
        font-size: 0.82rem;
        color: #888;
        font-weight: 500;
    }

    .cat-count {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1;
        color: #333;
    }

    .cat-body {
        padding: 0 20px 20px;
        display: flex;
        align-items: center;
        gap: 20px;
    }

    /* Pie chart via conic-gradient */
    .pie-wrap {
        position: relative;
        flex-shrink: 0;
    }

    .pie-chart {
        width: 130px;
        height: 130px;
        border-radius: 50%;
        position: relative;
        cursor: pointer;
    }

    .pie-hole {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        font-weight: 800;
        color: #333;
        pointer-events: none;
    }

    .pie-tooltip {
        display: none;
        position: absolute;
        background: rgba(0,0,0,0.82);
        color: #fff;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.78rem;
        font-weight: 600;
        white-space: nowrap;
        z-index: 20;
        pointer-events: none;
        transform: translate(-50%, -110%);
        left: 50%;
        top: 0;
    }

    .pie-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: rgba(0,0,0,0.82);
    }

    /* Legend */
    .pie-legend {
        flex: 1;
        min-width: 0;
    }

    .legend-item {
        display: flex;
        align-items: center;
        padding: 7px 0;
        border-bottom: 1px solid #f5f5f5;
        cursor: default;
    }

    .legend-item:last-child { border-bottom: none; }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        margin-right: 10px;
        flex-shrink: 0;
    }

    .legend-name {
        font-size: 0.84rem;
        color: #555;
        flex-grow: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .legend-val {
        font-size: 0.88rem;
        font-weight: 700;
        color: #333;
        margin-left: 8px;
        white-space: nowrap;
    }

    .legend-pct {
        font-size: 0.76rem;
        color: #999;
        margin-left: 4px;
        min-width: 34px;
        text-align: right;
    }

    .cat-empty {
        font-size: 0.82rem;
        color: #bbb;
        text-align: center;
        padding: 20px 0;
        width: 100%;
    }

    /* Q chips */
    .q-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #f0f0f0;
    }

    .q-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.76rem;
        font-weight: 700;
    }

    .q-chip.q1 { background: #d1e7dd; color: #198754; }
    .q-chip.q2 { background: #cfe2ff; color: #0d6efd; }
    .q-chip.q3 { background: #fff3cd; color: #856404; }
    .q-chip.q4 { background: #f8d7da; color: #dc3545; }

    /* Table */
    .tbl { font-size: 0.88rem; margin: 0; }

    .tbl thead th {
        background: #f8f9fa;
        padding: 8px 12px;
        font-weight: 600;
        font-size: 0.78rem;
        text-transform: uppercase;
        color: #666;
        border: none;
        white-space: nowrap;
    }

    .tbl thead th.group-header {
        text-align: center;
        font-size: 0.72rem;
        color: #999;
        border-bottom: 1px solid #e0e0e0 !important;
        padding-bottom: 4px;
    }

    .tbl thead th.sub-header { padding-top: 4px; }

    .tbl .col-group-start { border-left: 2px solid #e0e0e0 !important; }

    .tbl tbody td {
        padding: 10px 12px;
        border-color: #f0f0f0;
        vertical-align: middle;
    }

    .tbl .col-total { color: #667eea; font-weight: 700; font-size: 1rem; }

    .mini-bar-wrap {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
    }

    .mini-bar {
        width: 60px;
        height: 6px;
        border-radius: 3px;
        background: #eee;
        overflow: hidden;
        flex-shrink: 0;
    }

    .mini-bar-fill {
        height: 100%;
        border-radius: 3px;
        background: linear-gradient(90deg, #667eea, #764ba2);
    }

    .row-best { background: #f0f4ff; }

    .row-best td:first-child::after {
        content: " \2605";
        color: #667eea;
        font-size: 0.7rem;
    }
</style>

<!-- Header -->
<div class="rpt-header mt-3">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h4 class="mb-1"><i class="bi bi-file-earmark-bar-graph me-2"></i>Báo cáo tổng hợp giờ nghiên cứu</h4>
            <div class="user-info">
                <span><i class="bi bi-person me-1"></i>{{ user.full_name }}</span>
                {% if user.department %}
                <span class="ms-3"><i class="bi bi-building me-1"></i>{{ user.department }}</span>
                {% endif %}
                {% if user.employee_id %}
                <span class="ms-3"><i class="bi bi-card-text me-1"></i>{{ user.employee_id }}</span>
                {% endif %}
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('reports.export_csv') }}" class="btn btn-sm btn-outline-light">
                <i class="bi bi-filetype-csv me-1"></i>CSV
            </a>
            <a href="{{ url_for('reports.export_summary_txt') }}" class="btn btn-sm btn-outline-light">
                <i class="bi bi-filetype-txt me-1"></i>TXT
            </a>
        </div>
    </div>
</div>

<!-- Section: 3 Category Cards with Pie Charts -->
<div class="row g-3 mb-4">
    <!-- Card 1: Ấn phẩm khoa học -->
    <div class="col-lg-4">
        <div class="cat-card">
            <div class="cat-header">
                <div class="cat-icon" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                    <i class="bi bi-journal-richtext"></i>
                </div>
                <div>
                    <div class="cat-title">Ấn phẩm khoa học</div>
                    <div class="cat-count">{{ pub_overall.total_publications }}</div>
                </div>
            </div>
            {% set pub_total = pub_overall.total_publications if pub_overall.total_publications > 0 else 1 %}
            {% set pub_active = pub_groups|selectattr('count', 'gt', 0)|list %}
            <div class="cat-body">
                {% if pub_active|length > 0 %}
                <div class="pie-wrap">
                    {% set ns = namespace(offset=0, parts='', segs='') %}
                    {% for g in pub_active %}
                        {% set pct = (g.count / pub_total * 100)|round(1) %}
                        {% if not loop.first %}{% set ns.parts = ns.parts ~ ', ' %}{% set ns.segs = ns.segs ~ ',' %}{% endif %}
                        {% set ns.parts = ns.parts ~ g.color ~ ' ' ~ ns.offset ~ '% ' ~ (ns.offset + pct) ~ '%' %}
                        {% set ns.segs = ns.segs ~ ns.offset ~ ':' ~ (ns.offset + pct) %}
                        {% set ns.offset = ns.offset + pct %}
                    {% endfor %}
                    <div class="pie-chart" data-segments="{{ ns.segs }}" style="background: conic-gradient({{ ns.parts }});">
                        <div class="pie-hole">{{ pub_overall.total_publications }}</div>
                    </div>
                </div>
                <div class="pie-legend">
                    {% for g in pub_active %}
                    <div class="legend-item" data-tooltip="{{ g.label }}: {{ g.count }}">
                        <div class="legend-dot" style="background: {{ g.color }};"></div>
                        <span class="legend-name">{{ g.label }}</span>
                        <span class="legend-val">{{ g.count }}</span>
                        <span class="legend-pct">{{ (g.count / pub_total * 100)|round(0)|int }}%</span>
                    </div>
                    {% endfor %}
                    {% if pub_overall.wos_scopus_count > 0 %}
                    <div class="q-row">
                        <span class="q-chip q1">Q1 {{ pub_overall.by_quartile.Q1 }}</span>
                        <span class="q-chip q2">Q2 {{ pub_overall.by_quartile.Q2 }}</span>
                        <span class="q-chip q3">Q3 {{ pub_overall.by_quartile.Q3 }}</span>
                        <span class="q-chip q4">Q4 {{ pub_overall.by_quartile.Q4 }}</span>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="cat-empty">Chưa có dữ liệu</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Card 2: Đề tài, dự án -->
    <div class="col-lg-4">
        <div class="cat-card">
            <div class="cat-header">
                <div class="cat-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                    <i class="bi bi-folder-fill"></i>
                </div>
                <div>
                    <div class="cat-title">Đề tài, dự án</div>
                    <div class="cat-count">{{ total_projects }}</div>
                </div>
            </div>
            {% set proj_total = total_projects if total_projects > 0 else 1 %}
            {% set proj_active = project_by_level|selectattr('count', 'gt', 0)|list %}
            <div class="cat-body">
                {% if proj_active|length > 0 %}
                <div class="pie-wrap">
                    {% set ns = namespace(offset=0, parts='', segs='') %}
                    {% for item in proj_active %}
                        {% set pct = (item.count / proj_total * 100)|round(1) %}
                        {% if not loop.first %}{% set ns.parts = ns.parts ~ ', ' %}{% set ns.segs = ns.segs ~ ',' %}{% endif %}
                        {% set ns.parts = ns.parts ~ item.color ~ ' ' ~ ns.offset ~ '% ' ~ (ns.offset + pct) ~ '%' %}
                        {% set ns.segs = ns.segs ~ ns.offset ~ ':' ~ (ns.offset + pct) %}
                        {% set ns.offset = ns.offset + pct %}
                    {% endfor %}
                    <div class="pie-chart" data-segments="{{ ns.segs }}" style="background: conic-gradient({{ ns.parts }});">
                        <div class="pie-hole">{{ total_projects }}</div>
                    </div>
                </div>
                <div class="pie-legend">
                    {% for item in proj_active %}
                    <div class="legend-item">
                        <div class="legend-dot" style="background: {{ item.color }};"></div>
                        <span class="legend-name">{{ item.label }}</span>
                        <span class="legend-val">{{ item.count }}</span>
                        <span class="legend-pct">{{ (item.count / proj_total * 100)|round(0)|int }}%</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="cat-empty">Chưa có dữ liệu</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Card 3: HĐ KHCN khác -->
    <div class="col-lg-4">
        <div class="cat-card">
            <div class="cat-header">
                <div class="cat-icon" style="background: linear-gradient(135deg, #f5576c, #f093fb);">
                    <i class="bi bi-lightning-fill"></i>
                </div>
                <div>
                    <div class="cat-title">HĐ KHCN khác</div>
                    <div class="cat-count">{{ total_activities }}</div>
                </div>
            </div>
            {% set act_total = total_activities if total_activities > 0 else 1 %}
            {% set act_active = activity_by_type|selectattr('count', 'gt', 0)|list %}
            <div class="cat-body">
                {% if act_active|length > 0 %}
                <div class="pie-wrap">
                    {% set ns = namespace(offset=0, parts='', segs='') %}
                    {% for item in act_active %}
                        {% set pct = (item.count / act_total * 100)|round(1) %}
                        {% if not loop.first %}{% set ns.parts = ns.parts ~ ', ' %}{% set ns.segs = ns.segs ~ ',' %}{% endif %}
                        {% set ns.parts = ns.parts ~ item.color ~ ' ' ~ ns.offset ~ '% ' ~ (ns.offset + pct) ~ '%' %}
                        {% set ns.segs = ns.segs ~ ns.offset ~ ':' ~ (ns.offset + pct) %}
                        {% set ns.offset = ns.offset + pct %}
                    {% endfor %}
                    <div class="pie-chart" data-segments="{{ ns.segs }}" style="background: conic-gradient({{ ns.parts }});">
                        <div class="pie-hole">{{ total_activities }}</div>
                    </div>
                </div>
                <div class="pie-legend">
                    {% for item in act_active %}
                    <div class="legend-item">
                        <div class="legend-dot" style="background: {{ item.color }};"></div>
                        <span class="legend-name">{{ item.label }}</span>
                        <span class="legend-val">{{ item.count }}</span>
                        <span class="legend-pct">{{ (item.count / act_total * 100)|round(0)|int }}%</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="cat-empty">Chưa có dữ liệu</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% set best_year = yearly_data|sort(attribute='total_hours', reverse=true)|first if yearly_data else none %}
<!-- Section: CHI TIẾT THEO NĂM -->
{% set max_year_hours = yearly_data|map(attribute='total_hours')|max if yearly_data else 1 %}
{% set max_h = max_year_hours if max_year_hours > 0 else 1 %}
<div class="card card-clean mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-calendar3 me-2"></i>Chi tiết theo năm</span>
    </div>
    <div class="card-body p-0">
        {% if yearly_data %}
        <div class="table-responsive">
            <table class="table tbl">
                <thead>
                    <tr>
                        <th rowspan="2" class="align-middle">Năm</th>
                        <th colspan="3" class="group-header">Số lượng</th>
                        <th colspan="3" class="group-header col-group-start">Giờ quy đổi</th>
                        <th rowspan="2" class="text-end align-middle">Tổng giờ</th>
                        <th rowspan="2"></th>
                    </tr>
                    <tr>
                        <th class="text-center sub-header">Ấn phẩm</th>
                        <th class="text-center sub-header">Đề tài</th>
                        <th class="text-center sub-header">HĐ khác</th>
                        <th class="text-end sub-header col-group-start">Ấn phẩm</th>
                        <th class="text-end sub-header">Đề tài</th>
                        <th class="text-end sub-header">HĐ khác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in yearly_data %}
                    <tr{% if best_year and stat.year == best_year.year %} class="row-best"{% endif %}>
                        <td><strong>{{ stat.year }}</strong></td>
                        <td class="text-center">{{ stat.pub.total_publications }}</td>
                        <td class="text-center">{{ stat.project_count }}</td>
                        <td class="text-center">{{ stat.activity_count }}</td>
                        <td class="text-end col-group-start">{{ "%.0f"|format(stat.pub.total_author_hours) }}</td>
                        <td class="text-end">{{ "%.0f"|format(stat.project_hours) }}</td>
                        <td class="text-end">
                            {{ "%.0f"|format(stat.activity_hours) }}
                            {% if stat.activity_is_capped %}
                            <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 0.7rem;"
                                title="Đã giới hạn {{ max_activity_hours }} giờ/năm"></i>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <div class="mini-bar-wrap">
                                <span class="col-total">{{ "%.0f"|format(stat.total_hours) }}</span>
                                <div class="mini-bar">
                                    <div class="mini-bar-fill" style="width: {{ (stat.total_hours / max_h * 100)|round(1) }}%;"></div>
                                </div>
                            </div>
                        </td>
                        <td class="text-end">
                            <a href="{{ url_for('reports.yearly_report', year=stat.year) }}"
                                class="text-primary text-decoration-none" style="font-size: 0.82rem;">
                                Chi tiết <i class="bi bi-arrow-right"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr style="background: #f0f4ff;">
                        <td><strong>TỔNG</strong></td>
                        <td class="text-center"><strong>{{ pub_overall.total_publications }}</strong></td>
                        <td class="text-center"><strong>{{ overall_total.project_count }}</strong></td>
                        <td class="text-center">-</td>
                        <td class="text-end col-group-start"><strong>{{ "%.0f"|format(overall_total.publication_hours) }}</strong></td>
                        <td class="text-end"><strong>{{ "%.0f"|format(overall_total.project_hours) }}</strong></td>
                        <td class="text-end"><strong>{{ "%.0f"|format(overall_total.other_activity_hours) }}</strong></td>
                        <td class="text-end col-total"><strong>{{ "%.0f"|format(overall_total.total_hours) }}</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <p class="text-muted text-center py-4 mb-0">Chưa có dữ liệu</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pie chart hover: show tooltip with label + count
    document.querySelectorAll('.pie-chart').forEach(function(pie) {
        var card = pie.closest('.cat-body');
        var legends = card.querySelectorAll('.legend-item');
        var tooltip = document.createElement('div');
        tooltip.className = 'pie-tooltip';
        pie.parentNode.appendChild(tooltip);

        // Parse segment ranges from data attribute (e.g. "0:50,50:100")
        var segments = pie.dataset.segments.split(',').map(function(s) {
            var parts = s.split(':');
            return { from: parseFloat(parts[0]), to: parseFloat(parts[1]) };
        });

        pie.addEventListener('mousemove', function(e) {
            var rect = pie.getBoundingClientRect();
            var cx = rect.left + rect.width / 2;
            var cy = rect.top + rect.height / 2;
            var dx = e.clientX - cx;
            var dy = e.clientY - cy;
            var dist = Math.sqrt(dx * dx + dy * dy);
            var holeRadius = 30;

            if (dist < holeRadius) {
                tooltip.style.display = 'none';
                legends.forEach(function(l) { l.style.opacity = '1'; });
                return;
            }

            // conic-gradient starts from top (12 o'clock), goes clockwise
            var angle = Math.atan2(dx, -dy) * 180 / Math.PI;
            if (angle < 0) angle += 360;
            var pctAt = angle / 3.6;

            // Find which segment
            var idx = -1;
            for (var i = 0; i < segments.length; i++) {
                if (pctAt >= segments[i].from && pctAt < segments[i].to) {
                    idx = i;
                    break;
                }
            }
            // Handle edge case: last segment may not reach exactly 100 due to rounding
            if (idx === -1 && segments.length > 0) {
                idx = segments.length - 1;
            }

            if (idx >= 0 && idx < legends.length) {
                var li = legends[idx];
                var name = li.querySelector('.legend-name').textContent;
                var val = li.querySelector('.legend-val').textContent;
                var pct = li.querySelector('.legend-pct').textContent;
                tooltip.textContent = name + ': ' + val.trim() + ' (' + pct.trim() + ')';
                tooltip.style.display = 'block';
                var wrapRect = pie.parentNode.getBoundingClientRect();
                tooltip.style.left = (e.clientX - wrapRect.left) + 'px';
                tooltip.style.top = (e.clientY - wrapRect.top - 10) + 'px';
                tooltip.style.transform = 'translate(-50%, -100%)';

                legends.forEach(function(l) { l.style.opacity = '0.4'; });
                li.style.opacity = '1';
            } else {
                tooltip.style.display = 'none';
                legends.forEach(function(l) { l.style.opacity = '1'; });
            }
        });

        pie.addEventListener('mouseleave', function() {
            tooltip.style.display = 'none';
            legends.forEach(function(l) { l.style.opacity = '1'; });
        });
    });

    // Legend hover: highlight row
    document.querySelectorAll('.legend-item').forEach(function(li) {
        li.addEventListener('mouseenter', function() {
            var allLegends = li.closest('.pie-legend').querySelectorAll('.legend-item');
            allLegends.forEach(function(l) { l.style.opacity = '0.4'; });
            li.style.opacity = '1';
        });
        li.addEventListener('mouseleave', function() {
            var allLegends = li.closest('.pie-legend').querySelectorAll('.legend-item');
            allLegends.forEach(function(l) { l.style.opacity = '1'; });
        });
    });
});
</script>
{% endblock %}
