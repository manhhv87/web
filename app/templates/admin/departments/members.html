{% extends "base.html" %}

{% block title %}{{ department.name }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Admin</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('admin.manage_departments') }}">Bộ môn</a></li>
                <li class="breadcrumb-item active">{{ department.name }}</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-building me-2"></i>{{ department.name }}</h2>
            <div>
                <a href="{{ url_for('admin.edit_department', dept_id=department.id) }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-pencil me-1"></i>Sửa bộ môn
                </a>
            </div>
        </div>
        {% if department.description %}
        <p class="text-muted">{{ department.description }}</p>
        {% endif %}
    </div>
</div>

<!-- Year Filter -->
<div class="card mt-4">
    <div class="card-body py-2">
        <form method="get" class="row g-2 align-items-center">
            <div class="col-auto">
                <label class="form-label mb-0 me-2">Năm:</label>
            </div>
            <div class="col-auto">
                <select name="year" class="form-select form-select-sm" onchange="this.form.submit()">
                    {% for y in years %}
                    <option value="{{ y }}" {% if selected_year==y %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
</div>

<!-- Department Summary -->
<div class="row mt-4">
    <div class="col-md-2">
        <div class="card bg-primary text-white">
            <div class="card-body text-center py-3">
                <h3 class="mb-0">{{ dept_total.member_count }}</h3>
                <small>Thành viên</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-success text-white">
            <div class="card-body text-center py-3">
                <h3 class="mb-0">{{ dept_total.pub_count }}</h3>
                <small>Ấn phẩm</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white">
            <div class="card-body text-center py-3">
                <h3 class="mb-0">{{ dept_total.project_count }}</h3>
                <small>Đề tài</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center py-3">
                <div class="d-flex justify-content-around">
                    <div><strong>{{ dept_total.q_stats.Q1 }}</strong> <small>Q1</small></div>
                    <div><strong>{{ dept_total.q_stats.Q2 }}</strong> <small>Q2</small></div>
                    <div><strong>{{ dept_total.q_stats.Q3 }}</strong> <small>Q3</small></div>
                    <div><strong>{{ dept_total.q_stats.Q4 }}</strong> <small>Q4</small></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center py-3">
                <h3 class="mb-0">{{ "%.0f"|format(dept_total.total_hours) }}</h3>
                <small>Tổng giờ</small>
            </div>
        </div>
    </div>
</div>

<!-- Members Table -->
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-people me-2"></i>Thành viên bộ môn - Năm {{ selected_year }}
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Họ tên</th>
                        <th>Email</th>
                        <th class="text-center">Ấn phẩm</th>
                        <th class="text-center">Q1</th>
                        <th class="text-center">Q2</th>
                        <th class="text-center">Q3</th>
                        <th class="text-center">Q4</th>
                        <th class="text-center">Đề tài</th>
                        <th class="text-end">Tổng giờ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in member_data %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            <a href="{{ url_for('admin.view_user', user_id=item.user.id) }}">
                                {{ item.user.full_name }}
                            </a>
                        </td>
                        <td><small>{{ item.user.email }}</small></td>
                        <td class="text-center">{{ item.pub_count }}</td>
                        <td class="text-center">
                            {% if item.q_stats.Q1 > 0 %}<span class="badge bg-success">{{ item.q_stats.Q1 }}</span>{% else %}-{% endif %}
                        </td>
                        <td class="text-center">
                            {% if item.q_stats.Q2 > 0 %}<span class="badge bg-primary">{{ item.q_stats.Q2 }}</span>{% else %}-{% endif %}
                        </td>
                        <td class="text-center">
                            {% if item.q_stats.Q3 > 0 %}<span class="badge bg-warning text-dark">{{ item.q_stats.Q3 }}</span>{% else %}-{% endif %}
                        </td>
                        <td class="text-center">
                            {% if item.q_stats.Q4 > 0 %}<span class="badge bg-secondary">{{ item.q_stats.Q4 }}</span>{% else %}-{% endif %}
                        </td>
                        <td class="text-center">{{ item.project_count }}</td>
                        <td class="text-end"><strong>{{ "%.0f"|format(item.total_hours) }}</strong></td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">
                            Bộ môn chưa có thành viên nào.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if member_data %}
                <tfoot class="table-dark">
                    <tr>
                        <th colspan="3">Tổng cộng bộ môn</th>
                        <th class="text-center">{{ dept_total.pub_count }}</th>
                        <th class="text-center">{{ dept_total.q_stats.Q1 }}</th>
                        <th class="text-center">{{ dept_total.q_stats.Q2 }}</th>
                        <th class="text-center">{{ dept_total.q_stats.Q3 }}</th>
                        <th class="text-center">{{ dept_total.q_stats.Q4 }}</th>
                        <th class="text-center">{{ dept_total.project_count }}</th>
                        <th class="text-end"><strong>{{ "%.0f"|format(dept_total.total_hours) }}</strong></th>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('admin.manage_departments') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-1"></i>Quay lại danh sách bộ môn
    </a>
    <a href="{{ url_for('admin.reports') }}?year={{ selected_year }}&department={{ department.name }}" class="btn btn-outline-primary ms-2">
        <i class="bi bi-bar-chart me-1"></i>Xem báo cáo chi tiết
    </a>
</div>
{% endblock %}
